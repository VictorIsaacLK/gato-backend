"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const Route_1 = __importDefault(global[Symbol.for('ioc.use')]("Adonis/Core/Route"));
const Validator_1 = global[Symbol.for('ioc.use')]("Adonis/Core/Validator");
const Hash_1 = __importDefault(global[Symbol.for('ioc.use')]("Adonis/Core/Hash"));
const Env_1 = __importDefault(global[Symbol.for('ioc.use')]("Adonis/Core/Env"));
const Sms_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Mailers/Sms"));
const VerifyEmail_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Mailers/VerifyEmail"));
const Database_1 = __importDefault(global[Symbol.for('ioc.use')]("Adonis/Lucid/Database"));
const User_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/User"));
class LogginsController {
    async create({ request, response }) {
        const newUserSchema = Validator_1.schema.create({
            name: Validator_1.schema.string({
                trim: true, escape: true
            }, [
                Validator_1.rules.required(),
                Validator_1.rules.maxLength(100),
                Validator_1.rules.minLength(3)
            ]),
            email: Validator_1.schema.string({
                trim: true
            }, [
                Validator_1.rules.required(),
                Validator_1.rules.email(),
                Validator_1.rules.unique({ table: 'users', column: 'email' })
            ]),
            password: Validator_1.schema.string({
                trim: true
            }, [
                Validator_1.rules.required(),
                Validator_1.rules.minLength(4)
            ]),
            phone: Validator_1.schema.string({
                trim: true, escape: true
            }, [
                Validator_1.rules.required(),
                Validator_1.rules.minLength(10),
                Validator_1.rules.maxLength(10)
            ]),
        });
        const payload = await request.validate({ schema: newUserSchema,
            messages: {
                "name.required": "El nombre es requerido",
                "name.string": "El nombre debe ser un texto",
                "name.minLength": "El nombre debe tener al menos 3 caracteres",
                "name.maxLength": "El nombre debe tener como máximo 100 caracteres",
                "email.required": "El email es requerido",
                "email.string": "El email debe ser un texto",
                "email.email": "El email debe ser un email válido",
                "email.unique": "El email ya está en uso",
                "password.required": "La contraseña es requerida",
                "password.string": "La contraseña debe ser un texto",
                "password.minLength": "La contraseña debe tener al menos 4 caracteres",
                "telefono.required": "El teléfono es requerido",
                "telefono.minLength": "Debe tener al menos 10 caracteres",
                "telefono.maxLength": "Debe tener como máximo 10 caracteres",
            } });
        payload['password'] = await Hash_1.default.make(payload['password']);
        const code = (Math.floor(Math.random() * 8999) - 33).toString();
        payload['code'] = code;
        const user = await User_1.default.create(payload);
        if (user) {
            const signedUrl = Route_1.default.makeSignedUrl('verifyEmail', { id: user.id }, { expiresIn: '30m', prefixUrl: Env_1.default.get('APP_URL') });
            if (signedUrl) {
                const emailMessage = await new VerifyEmail_1.default(user, signedUrl);
                emailMessage.sendLater();
                return response.status(201).send({
                    message: 'Revisa tu correo para activar tu cuenta!',
                    user: user,
                    url: signedUrl
                });
            }
            else {
                return response.status(400).send({
                    message: 'No se pudo enviar el correo de confirmacion'
                });
            }
        }
    }
    async verifyEmail({ response, params }) {
        const user = await User_1.default.findOrFail(params.id);
        if (user.status == true) {
            return response.badRequest({ message: 'Usuario ya activo' });
        }
        else {
            const sms = await new Sms_1.default(user);
            sms.sendLater();
            const signedUrl = Route_1.default.makeSignedUrl('verifyCode', { id: user.id }, { expiresIn: '30m', prefixUrl: Env_1.default.get('APP_URL') });
            return response.ok({ message: 'El correo ha sido enviado a tu celular', url: signedUrl });
        }
    }
    async verifyCode({ request, response }) {
        const newCodeSchema = Validator_1.schema.create({
            code: Validator_1.schema.string({ trim: true, escape: true }, [Validator_1.rules.maxLength(4), Validator_1.rules.minLength(4)])
        });
        const payload = await request.validate({
            schema: newCodeSchema
        });
        const user = await Database_1.default.from('users').where('code', payload['code']).firstOrFail();
        if (user) {
            await Database_1.default.from('users').where('id', user.id).update({ status: true });
            return response.ok({ message: 'El usuario ha sido dado de alta de manera satisfactoria' });
        }
        else {
            return response.badRequest({ message: 'Este codigo no es valido' });
        }
    }
    async login({ request, response, auth }) {
        const newLogginSchema = Validator_1.schema.create({
            email: Validator_1.schema.string({
                trim: true
            }, [
                Validator_1.rules.required(),
                Validator_1.rules.email(),
                Validator_1.rules.exists({ table: 'users', column: 'email' })
            ]),
            password: Validator_1.schema.string({
                trim: true
            }, [
                Validator_1.rules.required(),
                Validator_1.rules.minLength(4)
            ]),
        });
        const payload = await request.validate({ schema: newLogginSchema,
            messages: {
                "email.required": "El email es requerido",
                "email.email": "El email debe ser un email válido",
                "email.exist": "El email debe haber sido registrado",
                "password.required": "La contraseña es requerida",
                "password.minLength": "La contraseña debe tener al menos 4 caracteres"
            }
        });
        const user = await User_1.default.findBy('email', payload['email']);
        if (user?.status == false) {
            return response.status(401).send({ error: [{ message: 'Usuario no activado' }] });
        }
        else if (user?.status == true) {
            const comparacionPassword = await Hash_1.default.verify(user.password, payload['password']);
            if (comparacionPassword) {
                const token = await auth.use('api').attempt(payload['email'], payload['password']);
                return response.ok({ token });
            }
            else {
                return response.status(401).send({ error: [{ message: 'Contraseña incorrecta' }] });
            }
        }
    }
    async logout({ auth, response }) {
        await auth.logout();
        return response.status(200).send({ message: 'Sesión cerrada' });
    }
}
exports.default = LogginsController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTG9nZ2luc0NvbnRyb2xsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJMb2dnaW5zQ29udHJvbGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUNBLG9GQUEwQztBQUMxQywyRUFBMEQ7QUFDMUQsa0ZBQXlDO0FBQ3pDLGdGQUF1QztBQUN2QyxnRkFBa0M7QUFDbEMsZ0dBQWtEO0FBQ2xELDJGQUFrRDtBQUNsRCxpRkFBbUM7QUFFbkMsTUFBcUIsaUJBQWlCO0lBRTdCLEtBQUssQ0FBQyxNQUFNLENBQUMsRUFBQyxPQUFPLEVBQUUsUUFBUSxFQUFzQjtRQUUxRCxNQUFNLGFBQWEsR0FBRyxrQkFBTSxDQUFDLE1BQU0sQ0FBQztZQUNsQyxJQUFJLEVBQUUsa0JBQU0sQ0FBQyxNQUFNLENBQUM7Z0JBQ2xCLElBQUksRUFBRSxJQUFJLEVBQUUsTUFBTSxFQUFFLElBQUk7YUFDekIsRUFBRTtnQkFDRCxpQkFBSyxDQUFDLFFBQVEsRUFBRTtnQkFDaEIsaUJBQUssQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDO2dCQUNwQixpQkFBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7YUFDbkIsQ0FBQztZQUNGLEtBQUssRUFBRSxrQkFBTSxDQUFDLE1BQU0sQ0FBQztnQkFDbkIsSUFBSSxFQUFFLElBQUk7YUFDWCxFQUFFO2dCQUNELGlCQUFLLENBQUMsUUFBUSxFQUFFO2dCQUNoQixpQkFBSyxDQUFDLEtBQUssRUFBRTtnQkFDYixpQkFBSyxDQUFDLE1BQU0sQ0FBQyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsTUFBTSxFQUFHLE9BQU8sRUFBQyxDQUFDO2FBQ2xELENBQUM7WUFDRixRQUFRLEVBQUUsa0JBQU0sQ0FBQyxNQUFNLENBQUM7Z0JBQ3RCLElBQUksRUFBRSxJQUFJO2FBQ1gsRUFBRTtnQkFDRCxpQkFBSyxDQUFDLFFBQVEsRUFBRTtnQkFDaEIsaUJBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO2FBQ25CLENBQUM7WUFD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Q0FBQztRQUNwQixPQUFPLFFBQVEsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUMsT0FBTyxFQUFFLGdCQUFnQixFQUFDLENBQUMsQ0FBQTtJQUMvRCxDQUFDO0NBQ0Y7QUEvTEQsb0NBK0xDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBIdHRwQ29udGV4dENvbnRyYWN0IH0gZnJvbSAnQGlvYzpBZG9uaXMvQ29yZS9IdHRwQ29udGV4dCdcbmltcG9ydCBSb3V0ZSBmcm9tICdAaW9jOkFkb25pcy9Db3JlL1JvdXRlJ1xuaW1wb3J0IHsgc2NoZW1hLCBydWxlcyB9IGZyb20gJ0Bpb2M6QWRvbmlzL0NvcmUvVmFsaWRhdG9yJ1xuaW1wb3J0IEhhc2ggZnJvbSAnQGlvYzpBZG9uaXMvQ29yZS9IYXNoJztcbmltcG9ydCBFbnYgZnJvbSAnQGlvYzpBZG9uaXMvQ29yZS9FbnYnO1xuaW1wb3J0IFNtcyBmcm9tICdBcHAvTWFpbGVycy9TbXMnO1xuaW1wb3J0IFZlcmlmeUVtYWlsIGZyb20gJ0FwcC9NYWlsZXJzL1ZlcmlmeUVtYWlsJztcbmltcG9ydCBEYXRhYmFzZSBmcm9tICdAaW9jOkFkb25pcy9MdWNpZC9EYXRhYmFzZSc7XG5pbXBvcnQgVXNlciBmcm9tICdBcHAvTW9kZWxzL1VzZXInO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBMb2dnaW5zQ29udHJvbGxlclxue1xuICBwdWJsaWMgYXN5bmMgY3JlYXRlKHtyZXF1ZXN0LCByZXNwb25zZX06IEh0dHBDb250ZXh0Q29udHJhY3QpXG4gIHtcbiAgICBjb25zdCBuZXdVc2VyU2NoZW1hID0gc2NoZW1hLmNyZWF0ZSh7XG4gICAgICBuYW1lOiBzY2hlbWEuc3RyaW5nKHtcbiAgICAgICAgdHJpbTogdHJ1ZSwgZXNjYXBlOiB0cnVlXG4gICAgICB9LCBbXG4gICAgICAgIHJ1bGVzLnJlcXVpcmVkKCksXG4gICAgICAgIHJ1bGVzLm1heExlbmd0aCgxMDApLFxuICAgICAgICBydWxlcy5taW5MZW5ndGgoMylcbiAgICAgIF0pLFxuICAgICAgZW1haWw6IHNjaGVtYS5zdHJpbmcoe1xuICAgICAgICB0cmltOiB0cnVlXG4gICAgICB9LCBbXG4gICAgICAgIHJ1bGVzLnJlcXVpcmVkKCksXG4gICAgICAgIHJ1bGVzLmVtYWlsKCksXG4gICAgICAgIHJ1bGVzLnVuaXF1ZSh7IHRhYmxlOiAndXNlcnMnLCBjb2x1bW4gOiAnZW1haWwnfSlcbiAgICAgIF0pLFxuICAgICAgcGFzc3dvcmQ6IHNjaGVtYS5zdHJpbmcoe1xuICAgICAgICB0cmltOiB0cnVlXG4gICAgICB9LCBbXG4gICAgICAgIHJ1bGVzLnJlcXVpcmVkKCksXG4gICAgICAgIHJ1bGVzLm1pbkxlbmd0aCg0KVxuICAgICAgXSksXG4gICAgICBwaG9uZTogc2NoZW1hLnN0cmluZyh7XG4gICAgICAgIHRyaW06IHRydWUsIGVzY2FwZTogdHJ1ZVxuICAgICAgfSwgW1xuICAgICAgICBydWxlcy5yZXF1aXJlZCgpLFxuICAgICAgICBydWxlcy5taW5MZW5ndGgoMTApLFxuICAgICAgICBydWxlcy5tYXhMZW5ndGgoMTApXG4gICAgICBdKSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHBheWxvYWQgPSBhd2FpdCByZXF1ZXN0LnZhbGlkYXRlXG4gICAgKHtzY2hlbWE6IG5ld1VzZXJTY2hlbWEsXG4gICAgICBtZXNzYWdlczpcbiAgICAgIHtcbiAgICAgICAgXCJuYW1lLnJlcXVpcmVkXCI6IFwiRWwgbm9tYnJlIGVzIHJlcXVlcmlkb1wiLFxuICAgICAgICBcIm5hbWUuc3RyaW5nXCI6IFwiRWwgbm9tYnJlIGRlYmUgc2VyIHVuIHRleHRvXCIsXG4gICAgICAgIFwibmFtZS5taW5MZW5ndGhcIjogXCJFbCBub21icmUgZGViZSB0ZW5lciBhbCBtZW5vcyAzIGNhcmFjdGVyZXNcIixcbiAgICAgICAgXCJuYW1lLm1heExlbmd0aFwiOiBcIkVsIG5vbWJyZSBkZWJlIHRlbmVyIGNvbW8gbcOheGltbyAxMDAgY2FyYWN0ZXJlc1wiLFxuXG4gICAgICAgIFwiZW1haWwucmVxdWlyZWRcIjogXCJFbCBlbWFpbCBlcyByZXF1ZXJpZG9cIixcbiAgICAgICAgXCJlbWFpbC5zdHJpbmdcIjogXCJFbCBlbWFpbCBkZWJlIHNlciB1biB0ZXh0b1wiLFxuICAgICAgICBcImVtYWlsLmVtYWlsXCI6IFwiRWwgZW1haWwgZGViZSBzZXIgdW4gZW1haWwgdsOhbGlkb1wiLFxuICAgICAgICBcImVtYWlsLnVuaXF1ZVwiOiBcIkVsIGVtYWlsIHlhIGVzdMOhIGVuIHVzb1wiLFxuXG4gICAgICAgIFwicGFzc3dvcmQucmVxdWlyZWRcIjogXCJMYSBjb250cmFzZcOxYSBlcyByZXF1ZXJpZGFcIixcbiAgICAgICAgXCJwYXNzd29yZC5zdHJpbmdcIjogXCJMYSBjb250cmFzZcOxYSBkZWJlIHNlciB1biB0ZXh0b1wiLFxuICAgICAgICBcInBhc3N3b3JkLm1pbkxlbmd0aFwiOiBcIkxhIGNvbnRyYXNlw7FhIGRlYmUgdGVuZXIgYWwgbWVub3MgNCBjYXJhY3RlcmVzXCIsXG5cbiAgICAgICAgXCJ0ZWxlZm9uby5yZXF1aXJlZFwiOiBcIkVsIHRlbMOpZm9ubyBlcyByZXF1ZXJpZG9cIixcbiAgICAgICAgXCJ0ZWxlZm9uby5taW5MZW5ndGhcIjogXCJEZWJlIHRlbmVyIGFsIG1lbm9zIDEwIGNhcmFjdGVyZXNcIixcbiAgICAgICAgXCJ0ZWxlZm9uby5tYXhMZW5ndGhcIjogXCJEZWJlIHRlbmVyIGNvbW8gbcOheGltbyAxMCBjYXJhY3RlcmVzXCIsXG4gICAgICB9fSlcblxuICAgIHBheWxvYWRbJ3Bhc3N3b3JkJ10gPSBhd2FpdCBIYXNoLm1ha2UocGF5bG9hZFsncGFzc3dvcmQnXSlcbiAgICBjb25zdCBjb2RlID0gKE1hdGguZmxvb3IoTWF0aC5yYW5kb20oKSAqIDg5OTkpIC0gMzMpLnRvU3RyaW5nKClcbiAgICBwYXlsb2FkWydjb2RlJ10gPSBjb2RlXG4gICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuY3JlYXRlKHBheWxvYWQpXG5cbiAgICBpZih1c2VyKVxuICAgIHtcbiAgICAgIGNvbnN0IHNpZ25lZFVybCA9IFJvdXRlLm1ha2VTaWduZWRVcmwoJ3ZlcmlmeUVtYWlsJyxcbiAgICAgIHtpZDogdXNlci5pZH0sIHtleHBpcmVzSW46ICczMG0nLCBwcmVmaXhVcmw6IEVudi5nZXQoJ0FQUF9VUkwnKX0pXG5cbiAgICAgIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAgIGlmKHNpZ25lZFVybClcbiAgICAgIHtcbiAgICAgICAgY29uc3QgZW1haWxNZXNzYWdlID0gYXdhaXQgbmV3IFZlcmlmeUVtYWlsKHVzZXIsIHNpZ25lZFVybClcbiAgICAgICAgZW1haWxNZXNzYWdlLnNlbmRMYXRlcigpXG5cbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cygyMDEpLnNlbmQoe1xuICAgICAgICAgIG1lc3NhZ2U6ICdSZXZpc2EgdHUgY29ycmVvIHBhcmEgYWN0aXZhciB0dSBjdWVudGEhJyxcbiAgICAgICAgICB1c2VyOiB1c2VyLFxuICAgICAgICAgIHVybDogc2lnbmVkVXJsXG4gICAgICAgIH0pXG4gICAgICB9XG4gICAgICBlbHNlXG4gICAgICB7XG4gICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNDAwKS5zZW5kKHtcbiAgICAgICAgICBtZXNzYWdlOiAnTm8gc2UgcHVkbyBlbnZpYXIgZWwgY29ycmVvIGRlIGNvbmZpcm1hY2lvbidcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9XG5cbiAgfVxuXG4gIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gIHB1YmxpYyBhc3luYyB2ZXJpZnlFbWFpbCh7cmVzcG9uc2UsIHBhcmFtc306IEh0dHBDb250ZXh0Q29udHJhY3QpXG4gIHtcbiAgICBjb25zdCB1c2VyID0gYXdhaXQgVXNlci5maW5kT3JGYWlsKHBhcmFtcy5pZClcbiAgICAvKiBjb25zb2xlLmxvZyh1c2VyKVxuICAgIGRlYnVnZ2VyICovIC8vc2kgdHJhZSBhbCB1c3VhcmlvIG1pZW50cmFzIHNlIHBhc2UgZWwgaWRcbiAgICBpZih1c2VyLnN0YXR1cyA9PSB0cnVlKXtcbiAgICAgIHJldHVybiByZXNwb25zZS5iYWRSZXF1ZXN0KHttZXNzYWdlOiAnVXN1YXJpbyB5YSBhY3Rpdm8nfSlcbiAgICB9XG4gICAgZWxzZVxuICAgIHtcbiAgICAgIGNvbnN0IHNtcyA9IGF3YWl0IG5ldyBTbXModXNlcilcbiAgICAgIHNtcy5zZW5kTGF0ZXIoKVxuICAgICAgY29uc3Qgc2lnbmVkVXJsID0gUm91dGUubWFrZVNpZ25lZFVybCgndmVyaWZ5Q29kZScsXG4gICAgICB7aWQ6IHVzZXIuaWR9LCB7ZXhwaXJlc0luOiAnMzBtJywgcHJlZml4VXJsOiBFbnYuZ2V0KCdBUFBfVVJMJyl9KVxuICAgICAgcmV0dXJuIHJlc3BvbnNlLm9rKHttZXNzYWdlOiAnRWwgY29ycmVvIGhhIHNpZG8gZW52aWFkbyBhIHR1IGNlbHVsYXInLCB1cmw6IHNpZ25lZFVybH0pXG4gICAgfVxuXG4gIH1cblxuICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICBwdWJsaWMgYXN5bmMgdmVyaWZ5Q29kZSh7cmVxdWVzdCwgcmVzcG9uc2V9OiBIdHRwQ29udGV4dENvbnRyYWN0KVxuICB7XG4gICAgY29uc3QgbmV3Q29kZVNjaGVtYSA9IHNjaGVtYS5jcmVhdGUoe1xuICAgICAgY29kZTogc2NoZW1hLnN0cmluZyh7dHJpbTogdHJ1ZSwgZXNjYXBlOiB0cnVlfSwgW3J1bGVzLm1heExlbmd0aCg0KSwgcnVsZXMubWluTGVuZ3RoKDQpXSlcbiAgICB9KTtcblxuICAgIGNvbnN0IHBheWxvYWQgPSBhd2FpdCByZXF1ZXN0LnZhbGlkYXRlKHtcbiAgICAgIHNjaGVtYTogbmV3Q29kZVNjaGVtYVxuICAgIH0pO1xuXG4gICAgY29uc3QgdXNlciA9IGF3YWl0IERhdGFiYXNlLmZyb20oJ3VzZXJzJykud2hlcmUoJ2NvZGUnLCBwYXlsb2FkWydjb2RlJ10pLmZpcnN0T3JGYWlsKClcbiAgICBpZih1c2VyKVxuICAgIHtcbiAgICAgIGF3YWl0IERhdGFiYXNlLmZyb20oJ3VzZXJzJykud2hlcmUoJ2lkJywgdXNlci5pZCkudXBkYXRlKHtzdGF0dXM6IHRydWV9KVxuICAgICAgcmV0dXJuIHJlc3BvbnNlLm9rKHttZXNzYWdlOiAnRWwgdXN1YXJpbyBoYSBzaWRvIGRhZG8gZGUgYWx0YSBkZSBtYW5lcmEgc2F0aXNmYWN0b3JpYSd9KVxuICAgIH1cbiAgICBlbHNlXG4gICAge1xuICAgICAgcmV0dXJuIHJlc3BvbnNlLmJhZFJlcXVlc3Qoe21lc3NhZ2U6ICdFc3RlIGNvZGlnbyBubyBlcyB2YWxpZG8nfSlcbiAgICB9XG5cbiAgICAvKiBpZihwYXlsb2FkWydjb2RlJ10gPT0gdXNlci5jb2RlKSAqL1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGxvZ2luKHtyZXF1ZXN0LCByZXNwb25zZSwgYXV0aH0pXG4gIHtcbiAgICBjb25zdCBuZXdMb2dnaW5TY2hlbWEgPSBzY2hlbWEuY3JlYXRlKHtcbiAgICAgIGVtYWlsOiBzY2hlbWEuc3RyaW5nKHtcbiAgICAgICAgdHJpbTogdHJ1ZVxuICAgICAgfSwgW1xuICAgICAgICBydWxlcy5yZXF1aXJlZCgpLFxuICAgICAgICBydWxlcy5lbWFpbCgpLFxuICAgICAgICBydWxlcy5leGlzdHMoe3RhYmxlOiAndXNlcnMnLCBjb2x1bW46ICdlbWFpbCd9KVxuICAgICAgXSksXG4gICAgICBwYXNzd29yZDogc2NoZW1hLnN0cmluZyh7XG4gICAgICAgIHRyaW06IHRydWVcbiAgICAgIH0sIFtcbiAgICAgICAgcnVsZXMucmVxdWlyZWQoKSxcbiAgICAgICAgcnVsZXMubWluTGVuZ3RoKDQpXG4gICAgICBdKSxcbiAgICB9KTtcblxuICAgIGNvbnN0IHBheWxvYWQgPSBhd2FpdCByZXF1ZXN0LnZhbGlkYXRlXG4gICAgKHtzY2hlbWE6IG5ld0xvZ2dpblNjaGVtYSxcbiAgICAgIG1lc3NhZ2VzOlxuICAgICAge1xuICAgICAgICBcImVtYWlsLnJlcXVpcmVkXCI6IFwiRWwgZW1haWwgZXMgcmVxdWVyaWRvXCIsXG4gICAgICAgIFwiZW1haWwuZW1haWxcIjogXCJFbCBlbWFpbCBkZWJlIHNlciB1biBlbWFpbCB2w6FsaWRvXCIsXG4gICAgICAgIFwiZW1haWwuZXhpc3RcIjogXCJFbCBlbWFpbCBkZWJlIGhhYmVyIHNpZG8gcmVnaXN0cmFkb1wiLFxuXG4gICAgICAgIFwicGFzc3dvcmQucmVxdWlyZWRcIjogXCJMYSBjb250cmFzZcOxYSBlcyByZXF1ZXJpZGFcIixcbiAgICAgICAgXCJwYXNzd29yZC5taW5MZW5ndGhcIjogXCJMYSBjb250cmFzZcOxYSBkZWJlIHRlbmVyIGFsIG1lbm9zIDQgY2FyYWN0ZXJlc1wiXG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBjb25zdCB1c2VyID0gYXdhaXQgVXNlci5maW5kQnkoJ2VtYWlsJywgcGF5bG9hZFsnZW1haWwnXSlcbiAgICBpZih1c2VyPy5zdGF0dXMgPT0gZmFsc2UpXG4gICAge1xuICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyg0MDEpLnNlbmQoe2Vycm9yOiBbe21lc3NhZ2U6ICdVc3VhcmlvIG5vIGFjdGl2YWRvJ31dfSlcbiAgICB9XG4gICAgZWxzZSBpZih1c2VyPy5zdGF0dXMgPT0gdHJ1ZSlcbiAgICB7XG4gICAgICBjb25zdCBjb21wYXJhY2lvblBhc3N3b3JkID0gYXdhaXQgSGFzaC52ZXJpZnkodXNlci5wYXNzd29yZCwgcGF5bG9hZFsncGFzc3dvcmQnXSlcbiAgICAgIGlmKGNvbXBhcmFjaW9uUGFzc3dvcmQpXG4gICAgICB7XG4gICAgICAgIGNvbnN0IHRva2VuID0gYXdhaXQgYXV0aC51c2UoJ2FwaScpLmF0dGVtcHQocGF5bG9hZFsnZW1haWwnXSwgcGF5bG9hZFsncGFzc3dvcmQnXSlcbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlLm9rKHt0b2tlbn0pXG4gICAgICB9XG4gICAgICBlbHNlXG4gICAgICB7XG4gICAgICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoNDAxKS5zZW5kKHtlcnJvcjogW3ttZXNzYWdlOiAnQ29udHJhc2XDsWEgaW5jb3JyZWN0YSd9XX0pXG4gICAgICB9XG4gICAgfVxuXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgbG9nb3V0KHthdXRoLCByZXNwb25zZX0pXG4gIHtcbiAgICBhd2FpdCBhdXRoLmxvZ291dCgpO1xuICAgIHJldHVybiByZXNwb25zZS5zdGF0dXMoMjAwKS5zZW5kKHttZXNzYWdlOiAnU2VzacOzbiBjZXJyYWRhJ30pXG4gIH1cbn1cbiJdfQ==